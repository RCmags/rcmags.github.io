---
layout: post
title: "Custom servo motor using a DC motor, H-bridge, and an analog sensor"
---

In the process of developing a [servo-powered ornithopter](/projects/ornithopters/2019/02/08/servo_ornithopter.html), I had the misfortune of burning multiple servos that I had purchased to oscillate the wings. This is because I had experimented with increasing the voltage of the servos, but the boards that drove them were incapable of operating at those higher voltages.
I was left with servos that were mechanically intact but electronically damaged. To make use of their perfectly fine mechanisms, I opted to control the servos with an Arduino. This would allow me to reuse them and provide me with the flexibility to safely increase the voltage. This is because I could choose a motor driver whose maximum voltages could be far higher than what the servos originally intended to operate at. An inexpensive H-bridge can operate up to 15 volts fairly easily, but a servo generally operates between 5 volts to a maximum  of 9 volts. With this in mind, the library was written to be a drop-in replacement to control a servo, assuming one had the following equipment.

- An Arduino
- An H-bridge
- A DC motor that can be reversed by flipping the voltage across it.
- An analog sensor that can measure the position of the motor.
		
You will also need a single analog pin and two pins capable of pwm output. See this page to find out what pwm pins are available on your [arduino board](https://www.arduino.cc/reference/en/language/functions/analog-io/analogwrite/)
	
Each of the components had to be connected in the following way. See the schematic below for the required conections: 

- The motor leads connect to the H-bridge.
- The H-bridge input pins are connected to the chosen pwm pins of the arduino.
- The sensor is connected to the chosen analog pin of the arduino.

![image](https://raw.githubusercontent.com/RCmags/ServoMotor/master/DIY_servo_schem.png)

__Note:__ the library used analogRead() to measure the sensor. As such, the entire rangeof motion would be divided to __1024__ individual steps. For a 180 degree rotation this means a maximum precision of __180/1024 ~ 0.18 degrees__.  

The motion of the servo was controlled via a PID loop. To reduce the overhead in storing constant values, the associated coefficients were set when a sketch is compiled and could not be changed once the arduino is running.  With these coefficients, it was possible to obtain very __smooth__ signals for the derivatives of the position. Without this information, it would have been very difficult to make the PID controller because of the stepped nature of the position measurements. These discrete jumps greatly increased the noise of any derivative, so smoothing had to be implemented one way or another to ensure a good approximation of the velocity of the output shaft. Credit goes to Pavel Holoborodko for the coefficients used to calculate the derivatives. See this page for his work on [noise robust differentiators](http://www.holoborodko.com/pavel/numerical-methods/numerical-derivative/smooth-low-noise-differentiators/).

{% include youtube.html id='FxEQQvTA3Fk' %}
<p align="center"><i>Video of a hobby servo that is controlled using this library</i></p>

Once the PID coefficients were tuned correctly, the server controller was capable of very precise and smooth motion. Obviously, it was not as precise as the original circuit of the servos, especially in the case of a digital servo, but it was certainly usable for many applications. It was also possible to arbitrarily raise the voltage of the servo and readjust the PID coefficients to prevent over-correction, which is something that pre-built servos are incapable of doing unless they can be programmed.

### Github Repo:
The Servo controller library can be downloaded directly from the following repository. It can also be downloaded the Arduino Library catalog. Alternatively, you can download it from the original RCgroups post. See the following links:

- [ServoMotor - Library](https://github.com/RCmags/ServoMotor)
- [Custom Servo Motor - RCgroups post](https://www.rcgroups.com/forums/showpost.php?p=43079349&postcount=164)
